<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAFS Dojo</title>
    <link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Bai Jamjuree', sans-serif;
            text-align: center;
            background-color: #f3ecd9;
            margin: 0;
            min-height: 100vh;
            position: relative;
        }
        .start-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding-top: 2rem;
        }
        .start-page h1 {
            font-size: 1.8rem;
            color: #e68434;
            margin-bottom: 1.5rem;
        }
        .start-page .score {
            font-size: 1rem;
            background-color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: inline-block;
        }
        .start-button {
            width: 360px;
            height: 360px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .start-button:hover {
            transform: scale(1.1);
        }
        #chapter-selection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 20;
            justify-content: center;
            align-items: center;
        }
        #chapter-selection-modal .modal-content {
            background-color: #c93c13;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
            font-size: 1em;
            line-height: 1.5;
        }
        #chapter-selection-modal .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        #chapter-selection-modal .chapter-options {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        #chapter-selection-modal .chapter-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #fff;
        }
        #chapter-selection-modal .chapter-option input {
            margin-right: 0.5rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        #chapter-selection-modal .chapter-option label {
            cursor: pointer;
        }
        #chapter-selection-modal .ownership-options {
            display: none;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        #chapter-selection-modal .ownership-options h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #fff;
        }
        #chapter-selection-modal .ownership-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #fff;
        }
        #chapter-selection-modal .ownership-option input {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            margin-right: 0.5rem;
            cursor: pointer;
            background-color: #fff;
        }
        #chapter-selection-modal .ownership-option input:checked {
            background-color: #00c4cc;
            border-color: #00c4cc;
        }
        #chapter-selection-modal .ownership-option label {
            cursor: pointer;
        }
        #chapter-selection-modal .try-luck-button {
            padding: 0.5rem 1rem;
            background-color: #f3ecdc;
            color: #c93c13;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        #chapter-selection-modal .try-luck-button:hover {
            background-color: #e0d9c8;
        }
        .game-content {
            display: none;
            max-width: 90%;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            text-align: center;
            padding-bottom: 2rem;
            cursor: url('https://i.postimg.cc/56XXW9WM/hand-cursor.png') 16 16, pointer;
        }
        .result-page {
            display: none;
            max-width: 90%;
            margin: 0 auto;
            padding: 1rem;
            text-align: center;
        }
        .result-page h1 {
            font-size: 1.5em;
            text-align: center;
            margin: 10px 0;
            color: #e68434;
        }
        .result-page .score {
            font-size: 1rem;
            background-color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            display: inline-block;
        }
        #results-container {
            display: none;
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        #correct-answers, #wrong-answers {
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            flex: 1;
            position: relative;
        }
        #correct-answers {
            margin-right: 5px;
        }
        #wrong-answers {
            margin-left: 5px;
        }
        #correct-answers h3, #wrong-answers h3 {
            margin: 0 0 5px;
            font-size: 1em;
            margin-right: 30px;
            text-align: left;
        }
        #correct-answers ul, #wrong-answers ul {
            list-style-type: decimal;
            text-align: left;
            padding-left: 20px;
            margin: 0;
        }
        #correct-answers li, #wrong-answers li {
            margin: 3px 0;
        }
        #correct-answers ul {
            list-style-position: outside;
            margin-left: 0;
        }
        #wrong-answers li {
            margin-bottom: 20px;
        }
        #copy-icon, #copy-correct-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            cursor: pointer;
        }
        #copy-feedback, #copy-correct-feedback {
            display: none;
            position: absolute;
            top: 35px;
            right: 10px;
            background-color: #fff;
            color: #333;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8em;
            border: 1px solid #ccc;
            z-index: 15;
        }
        .result-page .back-button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #c93c13;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }
        .result-page .back-button:hover {
            background-color: #a53210;
        }
        .end-message {
            font-family: 'Bai Jamjuree', sans-serif;
            font-size: 1.5em;
            color: #e68434;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .end-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 3;
        }
        .end-button:hover {
            transform: scale(1.1);
        }
        .row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .row.income-statement {
            justify-content: center; /* Center-align cups in the first row */
        }
        .cup-container {
            position: relative;
            width: 144px;
            height: 144px;
            margin: 0.5rem;
        }
        .cup {
            width: 100%;
            height: 100%;
            background: transparent;
            background-image: url('https://i.postimg.cc/9QhhfXqQ/original-cup.png');
            background-size: cover;
            color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: url('https://i.postimg.cc/56XXW9WM/hand-cursor.png') 16 16, pointer;
            font-size: 0;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        .cup:hover:not(.selected):not(.disappear) {
            background-image: url('https://i.postimg.cc/NfTtY2Fn/toggled-cup.png');
        }
        .cup.selected, .cup.disappear {
            animation: exitEffect 0.5s ease-in-out forwards;
            background-image: url('https://i.postimg.cc/NfTtY2Fn/toggled-cup.png');
        }
        @keyframes exitEffect {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg);
            }
            99% {
                opacity: 1;
                transform: translate(51.8px, -190.2px) rotate(40deg);
            }
            100% {
                opacity: 0;
                transform: translate(51.8px, -190.2px) rotate(40deg);
            }
        }
        .reveal-image {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
            display: block;
            opacity: 0;
            z-index: 1;
            transition: opacity 0.2s ease;
        }
        .cup.selected + .reveal-image,
        .cup.disappear + .reveal-image {
            opacity: 1;
        }
        .section-label {
            font-size: 0.9rem;
            color: #333;
            margin-top: 0.5rem;
            text-align: center;
        }
        .section-label.appropriation {
            white-space: nowrap; /* Prevent line break for "P&L - Appropriation" */
        }
        .score-wrapper, .question-wrapper {
            display: block;
            text-align: center;
        }
        .score {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            background-color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: inline-block;
            min-width: 100px;
        }
        .question {
            font-size: 1rem;
            margin-bottom: 1rem;
            background-color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: inline-block;
            min-width: 200px;
        }
        .feedback {
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        .logo {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            width: 90px;
            z-index: 10;
            cursor: pointer;
        }
        h1 {
            font-size: 1.2rem;
            text-align: center;
            margin: 0.5rem 0;
            color: #e68434;
        }
        .name-tag-container {
            position: relative;
            margin: 1rem auto;
        }
        .name-tag-container.tag1 {
            width: 300px;
            height: 60px;
        }
        .name-tag-container.tag2 {
            width: 375px;
            height: 60px;
        }
        .name-tag {
            width: 100%;
            height: 100%;
            display: block;
        }
        .name-tag-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: black;
            font-size: 1rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 100%;
        }
        .spacer-row {
            height: 1rem;
        }
        #instruction-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 20;
            justify-content: center;
            align-items: center;
        }
        #instruction-modal .modal-content {
            background-color: #c93c13;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
            font-size: 1em;
            line-height: 1.5;
        }
        #instruction-modal .modal-content p {
            margin: 10px 0;
        }
        #continue-button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #f3ecdc;
            color: #c93c13;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }
        #continue-button:hover {
            background-color: #e0d9c8;
        }
        @media (max-width: 600px) {
            .start-page h1 {
                font-size: 1.5rem;
            }
            .start-page .score {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }
            .start-button {
                width: 300px;
                height: 300px;
            }
            .end-button {
                width: 40px;
                height: 40px;
            }
            #chapter-selection-modal .modal-content h2 {
                font-size: 1.3rem;
            }
            #chapter-selection-modal .chapter-option {
                font-size: 0.9rem;
            }
            #chapter-selection-modal .chapter-option input {
                width: 18px;
                height: 18px;
            }
            #chapter-selection-modal .ownership-options h3 {
                font-size: 1rem;
            }
            #chapter-selection-modal .ownership-option {
                font-size: 0.9rem;
            }
            #chapter-selection-modal .ownership-option input {
                width: 18px;
                height: 18px;
            }
            .game-content {
                padding: 0.5rem;
                padding-bottom: 2rem;
                cursor: url('https://i.postimg.cc/56XXW9WM/hand-cursor.png') 6 6, pointer;
            }
            .result-page {
                padding-bottom: 90px; /* Reserve space for logo and button */
            }
            #results-container {
                flex-direction: column;
            }
            #correct-answers, #wrong-answers {
                margin: 0 0 10px 0;
                width: 100%;
                height: 115px; /* 8 lines for correct */
                overflow-y: auto;
            }
            #wrong-answers {
                height: 187px; /* 13 lines for incorrect */
            }
            .cup-container {
                width: 54px;
                height: 54px;
                margin: 0.2rem;
            }
            .cup {
                width: 54px;
                height: 54px;
                font-size: 0;
                cursor: url('https://i.postimg.cc/56XXW9WM/hand-cursor.png') 6 6, pointer;
            }
            .reveal-image {
                width: 54px;
                height: auto;
            }
            .section-label {
                font-size: 0.7rem;
            }
            .score {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
                min-width: 80px;
            }
            .question {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
                min-width: 150px;
            }
            .feedback {
                font-size: 0.8rem;
            }
            .logo {
                width: 72px;
            }
            h1 {
                font-size: 1rem;
            }
            .name-tag-container.tag1 {
                width: 240px;
                height: 48px;
            }
            .name-tag-container.tag2 {
                width: 300px;
                height: 48px;
            }
            .name-tag-text {
                font-size: 0.8rem;
            }
            .spacer-row {
                height: 0.8rem;
            }
            #copy-feedback, #copy-correct-feedback {
                top: 30px;
                right: 8px;
                font-size: 0.7em;
                padding: 4px 8px;
            }
        }
        @media (max-width: 360px) {
            #instruction-modal .modal-content, #chapter-selection-modal .modal-content {
                max-width: 90%;
                padding: 15px;
                font-size: 0.9em;
            }
            #chapter-selection-modal .modal-content h2 {
                font-size: 1.2rem;
            }
            #chapter-selection-modal .chapter-option {
                font-size: 0.8rem;
            }
            #chapter-selection-modal .chapter-option input {
                width: 16px;
                height: 16px;
            }
            #chapter-selection-modal .ownership-options h3 {
                font-size: 0.9rem;
            }
            #chapter-selection-modal .ownership-option {
                font-size: 0.8rem;
            }
            #chapter-selection-modal .ownership-option input {
                width: 16px;
                height: 16px;
            }
            .game-content {
                cursor: url('https://i.postimg.cc/56XXW9WM/hand-cursor.png') 5 5, pointer;
            }
            .cup-container {
                width: 42px;
                height: 42px;
                margin: 0.1rem;
            }
            .cup {
                width: 42px;
                height: 42px;
                cursor: url('https://i.postimg.cc/56XXW9WM/hand-cursor.png') 5 5, pointer;
            }
            .reveal-image {
                width: 42px;
                height: auto;
            }
            .section-label {
                font-size: 0.6rem;
            }
            .section-label.appropriation {
                font-size: 0.5rem; /* Smaller font for "P&L - Appropriation" */
            }
            .name-tag-container.tag1 {
                width: 180px;
                height: 36px;
            }
            .name-tag-container.tag2 {
                width: 225px;
                height: 36px;
            }
            .name-tag-text {
                font-size: 0.7rem;
            }
            #continue-button {
                padding: 8px 15px;
                font-size: 0.9em;
            }
            .spacer-row {
                height: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Audio elements for music and sound effects -->
    <audio id="background-music" loop>
        <source src="luckgame_bgm.mp3" type="audio/mpeg">
    </audio>
    <audio id="correct">
        <source src="bell_effect.mp3" type="audio/mpeg">
    </audio>
    <audio id="incorrect">
        <source src="shatter_effect.mp3" type="audio/mpeg">
    </audio>

    <div id="chapter-selection-modal">
        <div class="modal-content">
            <h2>What Chapters have you Learned?</h2>
            <div class="chapter-options">
                <div class="chapter-option">
                    <input type="checkbox" id="chp9" checked>
                    <label for="chp9">Chp.9 Accruals and Prepayments</label>
                </div>
                <div class="chapter-option">
                    <input type="checkbox" id="chp10" checked>
                    <label for="chp10">Chp.10 Bad Debts and Allowance for Doubtful Accounts</label>
                </div>
                <div class="chapter-option">
                    <input type="checkbox" id="chp11" checked>
                    <label for="chp11">Chp.11 Depreciation</label>
                </div>
                <div class="chapter-option">
                    <input type="checkbox" id="chp12" checked>
                    <label for="chp12">Chp.12 Inventory</label>
                </div>
                <div class="chapter-option">
                    <input type="checkbox" id="chp13" checked>
                    <label for="chp13">Chp.13 Partnership</label>
                </div>
            </div>
            <div class="ownership-options" id="ownership-options">
                <h3>Which form of ownership would you like to practise?</h3>
                <form id="ownership-form">
                    <div class="ownership-option">
                        <input type="radio" id="sole" name="ownership" value="sole">
                        <label for="sole">Sole Proprietorship</label>
                    </div>
                    <div class="ownership-option">
                        <input type="radio" id="partnership" name="ownership" value="partnership" checked>
                        <label for="partnership">Partnership</label>
                    </div>
                </form>
            </div>
            <button class="try-luck-button">Try my luck!</button>
        </div>
    </div>

    <div id="instruction-modal">
        <div class="modal-content">
            <p>Welcome to BAFS DOJO!<br>
            Apart from skill, <br> LUCK also plays a crucial role<br> in turning dreams into reality.<br><br>
            Classify accounting items into the <br> correct sections in Financial Statements.<br>
            Flip the right cups to find <br><strong><u>all Darumas</u></strong>!<br><br>
            Practice makes perfect!<br>
            May LUCK be your faithful companion <br>on every journey you embark on.</p>
            <button id="continue-button">Continue</button>
        </div>
    </div>
    <div class="start-page">
        <h1>May the Force be with You</h1>
        <div class="score">Score: 0 / 0</div>
        <img class="start-button" src="https://i.postimg.cc/cC6cmTND/daruma.png" alt="Start Button">
    </div>
    <div class="game-content">
        <img class="end-button" src="https://i.postimg.cc/gJ2qDd9y/exit.webp" alt="End Game">
        <h1>May the Force be with You</h1>
        <div class="score-wrapper">
            <div class="score" id="score">Score: 0 / 0</div>
        </div>
        <div class="question-wrapper">
            <div class="question" id="question"></div>
        </div>
        <div class="name-tag-container tag1">
            <img class="name-tag" src="https://i.postimg.cc/L4NC1CPF/name-tag.png" alt="Name Tag">
            <div class="name-tag-text">Income Statement</div>
        </div>
        <div class="row income-statement" id="income-statement-row">
            <div class="cup-container">
                <div class="cup" data-section="Trading"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">Trading</div>
            </div>
            <div class="cup-container">
                <div class="cup" data-section="P&L - Other Income"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">P&L - <br> Other Income</div>
            </div>
            <div class="cup-container">
                <div class="cup" data-section="P&L - Other Expenses"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">P&L - <br> Other Expenses</div>
            </div>
            <!-- P&L - Appropriation cup added dynamically if Chp.13 and Partnership -->
        </div>
        <div class="spacer-row"></div>
        <div class="spacer-row"></div>
        <div class="spacer-row"></div>
        <div class="name-tag-container tag2">
            <img class="name-tag" src="https://i.postimg.cc/L4NC1CPF/name-tag.png" alt="Name Tag">
            <div class="name-tag-text">Statement of Financial Position</div>
        </div>
        <div class="row">
            <div class="cup-container">
                <div class="cup" data-section="NCA"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">NCA</div>
            </div>
            <div class="cup-container">
                <div class="cup" data-section="CA"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">CA</div>
            </div>
            <div class="cup-container">
                <div class="cup" data-section="C"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">C</div>
            </div>
            <div class="cup-container">
                <div class="cup" data-section="NCL"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">NCL</div>
            </div>
            <div class="cup-container">
                <div class="cup" data-section="CL"></div>
                <img class="reveal-image" src="" alt="reveal">
                <div class="section-label">CL</div>
            </div>
        </div>
        <div class="feedback" id="feedback"></div>
    </div>
    <div class="result-page">
        <h1>May the Force be with You</h1>
        <div class="score" id="result-score"></div>
        <div class="end-message" id="end-message"></div>
        <div id="results-container">
            <div id="correct-answers">
                <h3></h3>
                <img id="copy-correct-icon" src="https://i.postimg.cc/fTZLr9yy/copy-grey.png" alt="Copy Correct Answers">
                <div id="copy-correct-feedback" class="copy-feedback">Copied!</div>
                <ul id="correct-answers-list"></ul>
            </div>
            <div id="wrong-answers">
                <h3></h3>
                <img id="copy-icon" src="https://i.postimg.cc/fTZLr9yy/copy-grey.png" alt="Copy Incorrect Answers">
                <div id="copy-feedback" class="copy-feedback">Copied!</div>
                <ul id="wrong-answers-list"></ul>
            </div>
        </div>
        <button class="back-button">Back to Start</button>
    </div>
    <a href="https://www.instagram.com/bafsdojo?igsh=MXhnNW9zN3JjMXJoMg%3D%3D&utm_source=qr" target="_blank">
        <img src="https://i.postimg.cc/0yMN6650/bafs-dojo.jpg" alt="BAFS Logo" class="logo">
    </a>

    <script>
        const originalItems = [
            { name: "Abnormal inventory loss", soleSections: ["Trading", "P&L - Other Expenses"], partnershipSections: ["Trading", "P&L - Other Expenses"], chapters: ["Chp12"], multiple: true },
            { name: "Accrued expenses", soleSections: ["CL"], partnershipSections: ["CL"], chapters: ["Chp9"] },
            { name: "Accrued income", soleSections: ["CA"], partnershipSections: ["CA"], chapters: ["Chp9"] },
            { name: "Accumulated Depreciation – [NCA]", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: ["Chp11"] },
            { name: "Administrative expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Advertising", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Allowance for doubtful accounts", soleSections: ["CA"], partnershipSections: ["CA"], chapters: ["Chp10"] },
            { name: "Allowance for doubtful debts", soleSections: ["CA"], partnershipSections: ["CA"], chapters: ["Chp10"] },
            { name: "Bad debts", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: ["Chp10"] },
            { name: "Bank", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Bank charges", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Bank interest income", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: [] },
            { name: "Bank loan", soleSections: ["NCL"], partnershipSections: ["NCL"], chapters: [] },
            { name: "Bank overdraft", soleSections: ["CL"], partnershipSections: ["CL"], chapters: [] },
            { name: "Buildings", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Capital", soleSections: ["C"], partnershipSections: [], chapters: [] },
            { name: "Carriage inwards", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Carriage outwards", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Cash", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Cleaning", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Commissions expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Commissions income", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: [] },
            { name: "Decrease in bad debts", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: ["Chp10"] },
            { name: "Deposit from customers (refundable)", soleSections: ["CL"], partnershipSections: ["CL"], chapters: [] },
            { name: "Deposit to suppliers (refundable)", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Depreciation – [NCA]", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: ["Chp11"] },
            { name: "Discounts allowed", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Discounts received", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: [] },
            { name: "Drawings", soleSections: ["C"], partnershipSections: ["C"], chapters: [] },
            { name: "Electricity", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Fixed deposit", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Fixtures and fittings", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "General expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Sundry expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Office expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Miscellaneous expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Heating and lighting", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Insurance", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Insurance compensation receivables", soleSections: ["CA"], partnershipSections: ["CA"], chapters: ["Chp11", "Chp12"] },
            { name: "Interest on deposit", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: [] },
            { name: "Interest on [loan from A]", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Interest on [loan to B]", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: [] },
            { name: "Interest on overdraft", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Internet charges", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Inventory, as at year start", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Inventory, as at year end", soleSections: ["Trading", "CA"], partnershipSections: ["Trading", "CA"], chapters: [], multiple: true },
            { name: "Land", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Loan from C", soleSections: ["NCL"], partnershipSections: ["NCL"], chapters: [] },
            { name: "Loan to D", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Loan interest expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Long-term investments", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Loss on disposal of [NCA]", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: ["Chp11"] },
            { name: "Machinery", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Management fees", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Motor expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Motor repairs", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Motor vehicles", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Net loss (in sole proprietorship)", soleSections: ["C"], partnershipSections: [], chapters: [] },
            { name: "Net profit (in sole proprietorship)", soleSections: ["C"], partnershipSections: [], chapters: [] },
            { name: "New capital contribution (in sole proprietorship)", soleSections: ["C"], partnershipSections: [], chapters: [] },
            { name: "Net loss (in partnership)", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Net profit (in partnership)", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Office equipment", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Other payables", soleSections: ["CL"], partnershipSections: ["CL"], chapters: [] },
            { name: "Other receivables", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Postages", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Premises", soleSections: ["NCA"], partnershipSections: ["NCA"], chapters: [] },
            { name: "Prepaid expenses", soleSections: ["CA"], partnershipSections: ["CA"], chapters: ["Chp9"] },
            { name: "Printing and stationery", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Profit on disposal of [NCA]", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: ["Chp11"] },
            { name: "Purchases", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Purchases returns", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Rent and rates", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Rental deposit from tenants", soleSections: ["CL"], partnershipSections: ["CL"], chapters: [] },
            { name: "Rental deposit to landlords", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Rental income", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: [] },
            { name: "Repairs and maintenance", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Returns inwards", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Returns outwards", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Revenue", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Revenue returns", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Sales", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Sales returns", soleSections: ["Trading"], partnershipSections: ["Trading"], chapters: [] },
            { name: "Selling and distribution costs", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Short-term investments", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Staff welfare and entertainment", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Telecommunications", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Telephone", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Time deposit", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Trade payables", soleSections: ["CL"], partnershipSections: ["CL"], chapters: [] },
            { name: "Trade receivables", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Travelling", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Unearned income", soleSections: ["CL"], partnershipSections: ["CL"], chapters: ["Chp9"] },
            { name: "Utilities", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Wages and salaries", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Water", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Sundry expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Office expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Miscellaneous expenses", soleSections: ["P&L - Other Expenses"], partnershipSections: ["P&L - Other Expenses"], chapters: [] },
            { name: "Term deposit", soleSections: ["CA"], partnershipSections: ["CA"], chapters: [] },
            { name: "Gain on disposal of [NCA]", soleSections: ["P&L - Other Income"], partnershipSections: ["P&L - Other Income"], chapters: ["Chp11"] },
            { name: "Net profit", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Net loss", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Interest on drawings", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Interest on capital", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Partner’s salary", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Share of profit", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Share of loss", soleSections: [], partnershipSections: ["P&L - Appropriation"], chapters: ["Chp13"] },
            { name: "Capital – [Partner]", soleSections: [], partnershipSections: ["C"], chapters: ["Chp13"] },
            { name: "Current – [Partner]", soleSections: [], partnershipSections: ["C"], chapters: ["Chp13"] },
            { name: "Loan from Partner", soleSections: [], partnershipSections: ["NCL"], chapters: ["Chp13"] },
            { name: "Interest on [loan from Partner]", soleSections: [], partnershipSections: ["P&L - Other Expenses"], chapters: ["Chp13"] }
        ];

        const darumaImages = [
            'https://i.postimg.cc/cC6cmTND/daruma.png',
            'https://i.postimg.cc/8F4hd5jd/daruma-black.png',
            'https://i.postimg.cc/ZBq6wSdG/daruma-blue.png',
            'https://i.postimg.cc/JHDZW5KK/daruma-green.png',
            'https://i.postimg.cc/c6rQYdZY/daruma-orange.png',
            'https://i.postimg.cc/ZBDpgMPC/daruma-pink.png',
            'https://i.postimg.cc/YjZQzTqP/daruma-yellow.png'
        ];

        let items = [...originalItems];
        let currentItem;
        let scoreCorrect = 0;
        let totalQuestions = 0;
        let correctAnswers = [];
        let incorrectAnswers = [];
        const cups = document.querySelectorAll('.cup');
        const questionDiv = document.getElementById('question');
        const feedbackDiv = document.getElementById('feedback');
        const scoreDiv = document.getElementById('score');
        const startPage = document.querySelector('.start-page');
        const chapterSelectionModal = document.getElementById('chapter-selection-modal');
        const gameContent = document.querySelector('.game-content');
        const resultPage = document.querySelector('.result-page');
        const startButton = document.querySelector('.start-button');
        const tryLuckButton = document.querySelector('.try-luck-button');
        const endButton = document.querySelector('.end-button');
        const instructionModal = document.getElementById('instruction-modal');
        const continueButton = document.getElementById('continue-button');
        const backButton = document.querySelector('.back-button');
        const resultsContainer = document.getElementById('results-container');
        const correctAnswersDiv = document.getElementById('correct-answers');
        const correctAnswersList = document.getElementById('correct-answers-list');
        const wrongAnswersDiv = document.getElementById('wrong-answers');
        const wrongAnswersList = document.getElementById('wrong-answers-list');
        const endMessage = document.getElementById('end-message');
        const resultScore = document.getElementById('result-score');
        const copyIcon = document.getElementById('copy-icon');
        const copyFeedback = document.getElementById('copy-feedback');
        const copyCorrectIcon = document.getElementById('copy-correct-icon');
        const copyCorrectFeedback = document.getElementById('copy-correct-feedback');
        const backgroundMusic = document.getElementById('background-music');
        const correctSound = document.getElementById('correct');
        const incorrectSound = document.getElementById('incorrect');
        const incomeStatementRow = document.getElementById('income-statement-row');
        const chp13Checkbox = document.getElementById('chp13');
        const ownershipOptions = document.getElementById('ownership-options');
        const ownershipForm = document.getElementById('ownership-form');

        // Set audio volumes
        backgroundMusic.volume = 0.4; // 40% of default volume
        correctSound.volume = 1.0; // Double volume (max)

        // Load saved chapter and ownership selections or set defaults
        let chapterSelections = JSON.parse(localStorage.getItem('chapterSelections')) || {
            Chp9: true,
            Chp10: true,
            Chp11: true,
            Chp12: true,
            Chp13: true
        };
        let ownershipSelection = localStorage.getItem('ownershipSelection') || 'partnership';

        function updateChapterCheckboxes() {
            document.getElementById('chp9').checked = chapterSelections.Chp9;
            document.getElementById('chp10').checked = chapterSelections.Chp10;
            document.getElementById('chp11').checked = chapterSelections.Chp11;
            document.getElementById('chp12').checked = chapterSelections.Chp12;
            document.getElementById('chp13').checked = chapterSelections.Chp13;
            ownershipOptions.style.display = chapterSelections.Chp13 ? 'flex' : 'none';
            document.getElementById('sole').checked = ownershipSelection === 'sole';
            document.getElementById('partnership').checked = ownershipSelection === 'partnership';
        }

        // Apply saved selections on page load
        updateChapterCheckboxes();

        // Toggle ownership options visibility
        chp13Checkbox.addEventListener('change', () => {
            ownershipOptions.style.display = chp13Checkbox.checked ? 'flex' : 'none';
        });

        function updateIncomeStatementRow() {
            // Remove any existing P&L - Appropriation cup
            const existingAppropriation = document.querySelector('[data-section="P&L - Appropriation"]');
            if (existingAppropriation) {
                existingAppropriation.parentElement.remove();
            }

            // Add P&L - Appropriation cup if Chp.13 is selected and ownership is Partnership
            if (chapterSelections.Chp13 && ownershipSelection === 'partnership') {
                const cupContainer = document.createElement('div');
                cupContainer.className = 'cup-container';
                cupContainer.innerHTML = `
                    <div class="cup" data-section="P&L - Appropriation"></div>
                    <img class="reveal-image" src="" alt="reveal">
                    <div class="section-label appropriation">P&L - <br> Appropriation</div>
                `;
                incomeStatementRow.appendChild(cupContainer);

                // Add click event listener to the new cup
                const newCup = cupContainer.querySelector('.cup');
                newCup.addEventListener('click', handleCupClick);
            }
        }

        // Common click handler for cups
        function handleCupClick() {
            if (this.style.pointerEvents === 'none') return;
            const selectedSections = [];
            if (currentItem.multiple) {
                this.classList.toggle('selected');
                selectedSections.push(...Array.from(document.querySelectorAll('.cup'))
                    .filter(c => c.classList.contains('selected'))
                    .map(c => c.dataset.section));
            } else {
                document.querySelectorAll('.cup').forEach(c => {
                    c.classList.remove('selected');
                    c.classList.remove('disappear');
                });
                this.classList.add('selected');
                selectedSections.push(this.dataset.section);
            }

            const correctSections = currentItem.sections || [];
            let isCorrect;
            if (currentItem.multiple) {
                isCorrect = selectedSections.some(section => correctSections.includes(section));
            } else {
                isCorrect = selectedSections.length === 1 && correctSections.includes(selectedSections[0]);
            }

            document.querySelectorAll('.cup').forEach(c => {
                const revealImage = c.nextElementSibling;
                if (c.classList.contains('selected')) {
                    revealImage.style.opacity = '1';
                    c.style.pointerEvents = 'none';
                }
            });

            if (!isCorrect) {
                let correctCupRevealed = false;
                document.querySelectorAll('.cup').forEach(c => {
                    if (!correctCupRevealed && correctSections.includes(c.dataset.section) && !c.classList.contains('selected')) {
                        c.classList.add('disappear');
                        c.nextElementSibling.style.opacity = '1';
                        c.style.pointerEvents = 'none';
                        correctCupRevealed = true;
                    }
                });
            }

            updateScore(isCorrect, correctSections);
            document.querySelectorAll('.cup').forEach(cup => cup.style.pointerEvents = 'none');
            setTimeout(setNewQuestion, isCorrect ? 1000 : 1500);
        }

        // Copy icon click handlers
        async function copyToClipboard(text, feedbackElement) {
            feedbackElement.style.display = 'block';
            setTimeout(() => {
                feedbackElement.style.display = 'none';
            }, 2000);

            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(text);
                    return;
                } catch (err) {
                    console.warn('Clipboard API failed:', err);
                }
            }

            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Fallback copy failed:', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        copyIcon.addEventListener('click', () => {
            const text = incorrectAnswers.length > 0
                ? incorrectAnswers.map(item => `${item.item.name}: ${item.correctSections.join(', ')}`).join('\n')
                : 'No incorrect answers';
            copyToClipboard(text, copyFeedback);
        });

        copyCorrectIcon.addEventListener('click', () => {
            const text = correctAnswers.length > 0
                ? correctAnswers.map(item => `${item.name}: ${item.sections.join(', ')}`).join('\n')
                : 'No correct answers';
            copyToClipboard(text, copyCorrectFeedback);
        });

        // Start button click handler to show chapter selection modal
        startButton.addEventListener('click', () => {
            startPage.style.display = 'none';
            chapterSelectionModal.style.display = 'flex';
        });

        // Try my luck button click handler to save selections and show instruction modal
        tryLuckButton.addEventListener('click', () => {
            chapterSelections = {
                Chp9: document.getElementById('chp9').checked,
                Chp10: document.getElementById('chp10').checked,
                Chp11: document.getElementById('chp11').checked,
                Chp12: document.getElementById('chp12').checked,
                Chp13: document.getElementById('chp13').checked
            };
            ownershipSelection = ownershipForm.querySelector('input[name="ownership"]:checked').value;
            localStorage.setItem('chapterSelections', JSON.stringify(chapterSelections));
            localStorage.setItem('ownershipSelection', ownershipSelection);
            updateIncomeStatementRow();
            chapterSelectionModal.style.display = 'none';
            instructionModal.style.display = 'flex';
        });

        // Continue button click handler to show game content and start background music
        continueButton.addEventListener('click', () => {
            instructionModal.style.display = 'none';
            gameContent.style.display = 'block';
            backgroundMusic.play().catch(err => console.warn('Background music playback failed:', err));
            setNewQuestion();
        });

        // Back button click handler to return to start page
        backButton.addEventListener('click', () => {
            resultPage.style.display = 'none';
            startPage.style.display = 'flex';
            gameContent.style.display = 'none';
            resultsContainer.style.display = 'none';
            scoreCorrect = 0;
            totalQuestions = 0;
            correctAnswers = [];
            incorrectAnswers = [];
            scoreDiv.textContent = `Score: 0 / 0`;
            feedbackDiv.textContent = '';
            items = [...originalItems];
            correctAnswersList.innerHTML = '';
            wrongAnswersList.innerHTML = '';
            endMessage.textContent = '';
            resultScore.textContent = '';
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
            updateChapterCheckboxes(); // Restore last selections
        });

        // End button click handler to show result page
        endButton.addEventListener('click', () => {
            feedbackDiv.textContent = 'Game Over!';
            document.querySelectorAll('.cup').forEach(cup => {
                cup.classList.add('disappear');
                cup.style.pointerEvents = 'none';
                const revealImage = cup.nextElementSibling;
                if (currentItem && currentItem.sections && currentItem.sections.includes(cup.dataset.section)) {
                    revealImage.src = darumaImages[Math.floor(Math.random() * darumaImages.length)];
                } else {
                    revealImage.src = 'https://i.postimg.cc/Wz6s5m6k/monster.png';
                }
                revealImage.style.opacity = '1';
            });
            endButton.style.pointerEvents = 'none';
            gameContent.style.display = 'none';
            resultPage.style.display = 'block';
            resultsContainer.style.display = 'flex';
            resultScore.textContent = `Score: ${scoreCorrect} / ${totalQuestions}`;
            const percentage = totalQuestions > 0 ? (scoreCorrect / totalQuestions * 100) : 0;
            if (percentage === 100 && scoreCorrect === items.length) {
                endMessage.textContent = "Congrats! You are the luckiest man on earth! 🙇🏻‍♂️";
            } else if (percentage === 100 || percentage >= 90) {
                endMessage.textContent = "You possess almost all the Forces in the universe!";
            } else if (percentage >= 80) {
                endMessage.textContent = "Closer to becoming the luckiest man!";
            } else if (percentage >= 70) {
                endMessage.textContent = "Good job!";
            } else if (percentage >= 50) {
                endMessage.textContent = "Nice Try!";
            } else {
                endMessage.innerHTML = "Sadly, you need more practice. <br>Luck comes with hard work.";
            }
            correctAnswersDiv.querySelector('h3').textContent = `Congrats! You've got ${correctAnswers.length} out of ${totalQuestions} correct!`;
            correctAnswersList.innerHTML = '';
            correctAnswersList.innerHTML = correctAnswers.map(item => `<li>${item.name}: ${item.sections.join(', ')}</li>`).join('');
            if (incorrectAnswers.length === 0) {
                wrongAnswersDiv.querySelector('h3').textContent = "You missed 0. Nailed it!";
                wrongAnswersList.innerHTML = '';
            } else {
                wrongAnswersDiv.querySelector('h3').innerHTML = `You missed ${incorrectAnswers.length}.<br>Can do better next time!`;
                wrongAnswersList.innerHTML = incorrectAnswers.map(item => `
                    <li>
                        <strong>${item.item.name}</strong>:<br>
                        ${item.correctSections.join(', ')}
                    </li>
                `).join('');
            }
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
        });

        function getRandomItem(filteredItems) {
            if (filteredItems.length === 0) return null;
            const index = Math.floor(Math.random() * filteredItems.length);
            const item = filteredItems[index];
            filteredItems.splice(index, 1);
            return item;
        }

        function setNewQuestion() {
            // Filter items based on selected chapters and ownership
            const selectedChapters = Object.keys(chapterSelections).filter(chp => chapterSelections[chp]);
            let filteredItems = originalItems.filter(item => {
                // Chapter filter: item must have no chapter requirement or match a selected chapter
                if (item.chapters.length > 0 && !item.chapters.some(chp => selectedChapters.includes(chp))) {
                    return false;
                }
                // Ownership filter: item must have sections for the chosen ownership
                const sections = ownershipSelection === 'sole' ? item.soleSections : item.partnershipSections;
                return sections.length > 0; // Exclude items with "N.A." (empty sections)
            });

            // Prioritize items based on selected chapters
            filteredItems.sort((a, b) => {
                const isChp11And13 = chapterSelections.Chp11 && chapterSelections.Chp13;
                if (isChp11And13) {
                    // Prioritize Chp.13, then Chp.11 in first 50 items
                    const aIsChp13 = a.chapters.includes('Chp13') ? -2 : 0;
                    const bIsChp13 = b.chapters.includes('Chp13') ? -2 : 0;
                    const aIsChp11 = a.chapters.includes('Chp11') ? -1 : 0;
                    const bIsChp11 = b.chapters.includes('Chp11') ? -1 : 0;
                    return (aIsChp13 + aIsChp11) - (bIsChp13 + bIsChp11);
                } else {
                    // Prioritize Chp.11 in first 30, others in first 15
                    const aIsChp11 = a.chapters.includes('Chp11') ? -2 : 0;
                    const bIsChp11 = b.chapters.includes('Chp11') ? -2 : 0;
                    const aIsOtherChapter = a.chapters.some(chp => ['Chp9', 'Chp10', 'Chp12'].includes(chp) && selectedChapters.includes(chp)) ? -1 : 0;
                    const bIsOtherChapter = b.chapters.some(chp => ['Chp9', 'Chp10', 'Chp12'].includes(chp) && selectedChapters.includes(chp)) ? -1 : 0;
                    return (aIsChp11 + aIsOtherChapter) - (bIsChp11 + bIsOtherChapter);
                }
            });

            // Apply limits based on prioritization
            if (chapterSelections.Chp11 && chapterSelections.Chp13) {
                filteredItems = filteredItems.slice(0, 50); // First 50 for Chp.11 and Chp.13
            } else if (chapterSelections.Chp11) {
                filteredItems = filteredItems.slice(0, 30); // First 30 for Chp.11
            } else if (selectedChapters.some(chp => ['Chp9', 'Chp10', 'Chp12'].includes(chp))) {
                filteredItems = filteredItems.slice(0, 15); // First 15 for other chapters
            }

            // If Chp.13 and Partnership, re-prioritize Chp.13 within the filtered set
            if (chapterSelections.Chp13 && ownershipSelection === 'partnership') {
                filteredItems.sort((a, b) => {
                    const aIsChp13 = a.chapters.includes('Chp13') ? -1 : 1;
                    const bIsChp13 = b.chapters.includes('Chp13') ? -1 : 1;
                    return aIsChp13 - bIsChp13;
                });
                filteredItems = filteredItems.slice(0, 50); // Ensure Chp.13 priority
            }

            items = filteredItems.map(item => ({
                ...item,
                sections: ownershipSelection === 'sole' ? item.soleSections : item.partnershipSections
            }));

            if (items.length === 0) {
                questionDiv.textContent = "";
                feedbackDiv.textContent = "No items available for selected chapters or ownership!";
                document.querySelectorAll('.cup').forEach(cup => cup.style.pointerEvents = 'none');
                endButton.style.pointerEvents = 'none';
                return;
            }

            currentItem = getRandomItem(items);
            if (!currentItem) {
                questionDiv.textContent = "";
                feedbackDiv.textContent = "Game Over!";
                document.querySelectorAll('.cup').forEach(cup => cup.style.pointerEvents = 'none');
                endButton.style.pointerEvents = 'none';
                return;
            }
            questionDiv.textContent = currentItem.name;
            document.querySelectorAll('.cup').forEach(cup => {
                cup.classList.remove('selected');
                cup.classList.remove('disappear');
                cup.style.pointerEvents = 'auto';
                cup.style.backgroundImage = "url('https://i.postimg.cc/9QhhfXqQ/original-cup.png')";
                const revealImage = cup.nextElementSibling;
                revealImage.src = currentItem.sections.includes(cup.dataset.section)
                    ? darumaImages[Math.floor(Math.random() * darumaImages.length)]
                    : 'https://i.postimg.cc/Wz6s5m6k/monster.png';
                revealImage.style.opacity = '0';
            });
            feedbackDiv.textContent = '';
            endButton.style.pointerEvents = 'auto';
        }

        function updateScore(isCorrect, correctSections) {
            totalQuestions++;
            if (isCorrect) {
                scoreCorrect++;
                correctAnswers.push(currentItem);
                correctSound.play().catch(err => console.warn('Correct sound playback failed:', err));
            } else {
                incorrectAnswers.push({ item: currentItem, correctSections: correctSections });
                setTimeout(() => {
                    incorrectSound.play().catch(err => console.warn('Incorrect sound playback failed:', err));
                }, 200); // 0.2-second delay
            }
            scoreDiv.textContent = `Score: ${scoreCorrect} / ${totalQuestions}`;
        }

        // Initial cup event listeners
        cups.forEach(cup => cup.addEventListener('click', handleCupClick));
    </script>
</body>
</html>
